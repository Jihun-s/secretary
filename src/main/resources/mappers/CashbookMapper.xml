<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.softsociety.secretary.dao.CashbookDAO">

<!-- 내역 입력 -->
<insert id="insertTrans" parameterType="Transaction">
INSERT INTO 
    Secretary_Transaction
        (trans_id
        , cashbook_id
        , user_id
        , family_id
        , trans_date
        , trans_type
        , cate1_id
        , cate2_id
        , trans_payee
        , trans_memo
        , trans_amount)
    VALUES 
        (Secretary_Trans_SEQ.nextval
        , #{cashbookId}
        , #{userId}
        , #{familyId}
        , TO_DATE(#{transDate}, 'YYYY-MM-DD"T"HH24:MI')
        , #{transType}
        , (SELECT cate1_id FROM Secretary_Trans_Category1 WHERE cate1_name = #{cate1Name})
        , (SELECT cate2_id FROM Secretary_Trans_Category2 WHERE cate2_name = #{cate2Name} AND cate1_id = (SELECT cate1_id FROM Secretary_Trans_Category1 WHERE cate1_name = #{cate1Name}))
        , #{transPayee}
        , #{transMemo}
        , #{transAmount}
        )
</insert>

<!-- 내역 전체 조회 -->
<select id="selectAllTrans" parameterType="int" resultType="Transaction">
	SELECT
	    st.trans_id
	    , st.cashbook_id
	    , st.user_id
	    , st.family_id
	    , TO_CHAR(st.trans_date, 'YYYY-MM-DD') as trans_date
	    , TO_CHAR(st.trans_date, 'HH24:MI') as trans_time
	    , st.trans_type
	    , st.cate1_id
	    , st.cate2_id
	    , stc1.cate1_name
	    , stc2.cate2_name
	    , st.trans_payee
	    , st.trans_memo
	    , st.trans_amount
	    , stc1.label_color as label_color
	FROM
	    Secretary_Transaction st
	LEFT JOIN
	    Secretary_Trans_Category1 stc1 ON st.cate1_id = stc1.cate1_id
	LEFT JOIN
	    Secretary_Trans_Category2 stc2 ON st.cate2_id = stc2.cate2_id
	WHERE
	    st.family_id = #{familyId}
	ORDER BY
	    st.trans_date DESC
</select>

<!-- 해당 월 내역 수 조회 -->
<select id="selectTransCntMonth" parameterType="hashmap" resultType="int">
	SELECT 
		COUNT(*) 
	FROM 
		Secretary_Transaction 
	WHERE 
		EXTRACT(MONTH FROM trans_date) = #{curMonth}
	AND 
		family_id = #{familyId}
</select>

<!-- 내역 삭제 -->
<delete id="deleteTrans" parameterType="Transaction">
	DELETE FROM Secretary_Transaction
	WHERE trans_id = #{transId} AND user_id = #{userId}
</delete>

<!-- 대분류 불러오기 -->
<select id="selectCate1" parameterType="string" resultType="Category1">
	SELECT 
	    cate1_id
	    , cate1_name
	    , is_custom
	    , trans_type
	    , family_id
	    , user_id
	FROM Secretary_Trans_Category1
	WHERE
	    trans_type = #{transType}
	ORDER BY cate1_id 
</select>

<!-- 소분류 불러오기 -->
<select id="selectCate2" parameterType="string" resultType="Category2">
	SELECT 
	    cate2_id
	    , C1.cate1_id AS cate1_id
	    , cate2_name
	    , C2.is_custom AS is_custom
	    , C1.family_id AS family_id
	    , C1.user_id AS user_id
	FROM Secretary_Trans_Category2 C2
	INNER JOIN Secretary_Trans_Category1 C1 ON C2.cate1_id = C1.cate1_id
	WHERE C1.cate1_name = #{cate1Name}
	ORDER BY cate2_id
</select>

<!-- 커스텀 대분류 추가 -->
<insert id="insertCustomCate1" parameterType="Category1">
	INSERT INTO
	    Secretary_Trans_Category1
	        (cate1_id
	        , cate1_name
	        , is_custom
	        , trans_type
	        , family_id
	        , user_id)
	    VALUES
	        (Secretary_Trans_Category1_SEQ.nextval
	        , #{cate1Name}
	        , 1
	        , #{transType}
	        , #{familyId}
	        , #{userId})
</insert>

<!-- 커스텀 소분류 추가 -->
<insert id="insertCustomCate2" parameterType="Category1">
	INSERT INTO
	    Secretary_Trans_Category2
	        (cate2_id
	        , cate1_id
	        , cate2_name
	        , is_custom
	        , family_id
	        , user_id)
	    VALUES
	        (Secretary_Trans_Category2_SEQ.nextval
	        , #{cate1Id}
	        , #{cate2Name}
	        , 1
	        , #{familyId}
	        , #{userId})
</insert>

<!-- 대분류 name으로 id 찾기 -->
<select id="selectCate1Id" parameterType="string" resultType="int">
	SELECT
		cate1_id
	FROM
		Secretary_Trans_Category1
	WHERE
		cate1_name = #{cate1Name}
</select>

<!-- 거래내역 하나 불러오기 -->
<select id="selectTrans" parameterType="int" resultType="Transaction">
	SELECT
	    st.trans_id
	    , st.cashbook_id
	    , st.user_id
	    , st.family_id
	    , TO_CHAR(st.trans_date, 'YYYY-MM-DD"T"HH24:MI:SS') as trans_date
	    , st.trans_type
	    , st.cate1_id
	    , st.cate2_id
	    , stc1.cate1_name
	    , stc2.cate2_name
	    , st.trans_payee
	    , st.trans_memo
	    , st.trans_amount
	    , stc1.label_color as label_color
	FROM
	    Secretary_Transaction st
	LEFT JOIN
	    Secretary_Trans_Category1 stc1 ON st.cate1_id = stc1.cate1_id
	LEFT JOIN
	    Secretary_Trans_Category2 stc2 ON st.cate2_id = stc2.cate2_id
	WHERE
	    st.trans_id = #{transId}
</select>
</mapper>